<html>
    <head>
        <title>busfarhn</title>
        
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=0.8, maximum-scale=3">

        <script src="/js/jquery.js"></script>
        <script src="/js/jquery.timeago.js"></script>
        <script src="/knob/jquery.knob.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        
        <link href="/metro/css/modern.css" rel="stylesheet">
        <link href="/metro/css/theme-dark.css" rel="stylesheet">
        <link href="/metro/css/modern-responsive.css" rel="stylesheet">
        
        <style>
            [class^="icon-"], [class*=" icon-"] {
                display: block;
                font-size:64px;
                line-height: 64px;
                position: absolute;
                width: 64px;
                height: 64px;
                top: 50%;
                left: 50%;
                margin-left: -32px;
                margin-top: -32px;
            }
            input {
                color: black !important;
                width: 100%;
                font-size: 150%;
                height: 2em;
            }
        </style>
        <script>
            var socket = io.connect();
            socket.on('connect_failed', function () {
                $('#socketStatus').html("OFFLINE"); 
                $('#socketDetails').html("connection failed"); 
            });
            socket.on('connect', function() {
                $('#socketStatus').html("Online");
                $('#socketDetails').html(""); 
                socket.on('disconnect', function(){ $('#socketStatus').html("OFFLINE"); });
            });
            
            function updateLastMessageTime(time) {
                var date = new Date(time);
                $('#socketDetails').html("last activity: <time class=\"timeago\" datetime=\"" + date.toISOString() + "\">" + date.toISOString() + "</time>");
                jQuery("time.timeago").timeago();
            }
        </script>
    </head>
    <body class="modern-ui">
        <div class="page secondary fixed-header">
        <div class="page-header ">
            <div class="page-header-content">
                <div class="user-login">
                    <a href="#">
                        <div class="name">
                            <span class="first-name" id="socketStatus">offline</span>
                            <span class="last-name" id="socketDetails">connecting</span>
                        </div>
                    </a>
                </div>

            
                <h1>busfarhn</h1>
            </div>
        </div>
    
        <div class="page-region">
        <div class="page-region-content tiles">
        {{#each config}}
             <div class="tile-group">
                <h3>{{label}}</h3>
                {{#each widgets}}
                    {{#type 'action'}}
                    {{#if icon}}
                    <div id="action{{id}}" class="tile{{#if color}} bg-color-{{color}}{{/if}}{{#if size}} {{size}}{{/if}} icon">
                        <div class="tile-content">
                            <i class="icon-{{icon}}">&nbsp;</i>
                        </div>
                        <div class="brand">
                            <div class="name">{{this.label}}</div>
                        </div>
                    </div>
                    {{else}}
                    <div id="action{{id}}" class="tile{{#if color}} bg-color-{{color}}{{/if}}{{#if size}} {{size}}{{/if}}">
                        <div class="tile-content">
                            <h4>{{this.label}}</h4>
                            {{this.desc}}
                        </div>
                        <div class="brand">
                            <div class="badge"></div>
                            <div class="name">{{this.type}}</div>
                        </div>
                    </div>
                    {{/if}}
                    
                    <script>$(function() { $("#action{{this.id}}").click(function(value) {
                        socket.emit('action{{this.id}}', "");
                    }); })</script>
                    {{/type}}
                    
                    {{#type 'range'}}
                    <div class="tile {{#if color}}bg-color-{{color}}{{else}}bg-color-orange{{/if}}{{#if size}} {{size}}{{/if}}">
                        <div class="tile-content">
                            <h4>{{this.label}}</h4>
                            {{this.desc}}
                            <input id="knob{{this.id}}" data-width="100" data-min="{{this.range.from}}" data-displayPrevious="true" data-max="{{this.range.to}}" data-fgColor="#222222" data-thickness=".5" />
                            <script>
                                $(function() { $("#knob{{this.id}}").knob({
                                    release: function(value) {
                                        var marshal = {{{this.message.marshal}}};
                                        socket.emit('rangeUpdate{{this.id}}', marshal(value));
                                    }
                                }); });
                                
                                socket.on('rangeUpdateView{{id}}', function (data) {
                                    var unmarshal = {{{this.message.unmarshal}}};
                                    $('#knob{{id}}').val(unmarshal(data.type, data.time, data.msg)).trigger('change');
                                    updateLastMessageTime(data.time); 
                                });
                            </script>
                        </div>
                    </div>
                    {{/type}}
                    
                    {{#type 'display'}}
                    <div id="displayAction{{id}}" class="tile {{#if color}}bg-color-{{color}}{{else}}bg-color-blue{{/if}}{{#if size}} {{size}}{{/if}}">
                        <div class="tile-content">
                            <h4>{{{this.label}}}</h4>
                            <span id="display{{id}}">&nbsp; {{{this.desc}}}</span>
                            
                            <script>
                                socket.on('display{{id}}', function (data) {
                                    {{#if message.update}}
                                    var update = {{{message.update}}};
                                    update('#displayAction{{id}}', data.type, data.time, data.msg);
                                    {{else}}
                                    var unmarshal = {{{message.unmarshal}}};
                                    $('#display{{id}}').html(unmarshal(data.type, data.time, data.msg));
                                    {{/if}}
                                    updateLastMessageTime(data.time); 
                                });
                            </script>
                            {{#if message.marshal}}
                            <script>
                            function exec{{this.id}}() {
                                var marshal = {{{this.message.marshal}}};
                                socket.emit('displayAction{{this.id}}', marshal( $("#display{{this.id}}").html() ));
                            }
                            
                            $(function() { $("#displayAction{{this.id}}").click(function(value) {
                                exec{{this.id}}();
                            }); })
                            </script>
                            {{/if}}
                        </div>
                    </div>
                    {{/type}}
                {{/each}}
            </div>
        {{/each}}
        </div>
        </div>

        </div>
    </body>
</html>
